# PID/mDL OID4VCI Draft 12 issuer - version 0.4 (no dynamic registration(NO AUTH))

Generates the nonce and credential of the PID/mDL in different formats (mdoc and SD-JWT) through a series of POST and GET requests.

Available *country* codes, for testing:

PID:
+ FC (Form Country) - a form, with the necessary PID/mDL attributes, will be presented to the user (EUDI Wallet holder). The user will insert the values, that will not be verified;
+ CW (country W) - the user will be redirected to the eIDAS node of country W (user:xavi, password:creus);
+ CZ (Czech Republic) - the user will be redirected to the eIDAS node of Czech Republic ;
+ EE (Estonia) - the user will be redirected to the Identity Provider of Estonia (https://e-gov.github.io/TARA-Doku/Testing#21-quick-reference-of-testing-accounts);
+ PT (Portugal) - the user will be redirected to the Identity Provider of Portugal .

mDL
+ FC (Form Country) - a form, with the necessary PID/mDL attributes, will be presented to the user (EUDI Wallet holder). The user will insert the values, that will not be verified;
+ PT (Portugal) - the user will be redirected to the Identity Provider of Portugal .

## 1. Get Metadata 
It starts by making a GET request for metadata.

<https://issuer.eudiw.dev/oidc/.well-known/openid-credential-issuer>

## 2. Push Authorization Request

Next, a POST request is made to perform the Push Authorization

For this request, the following fields need to be included:

+ *response_type* - “code” RFC 9126 section 2.1
+ *state* - RFC 9126 section 2.1
+ *client_id* - RFC 9126 section 2.1
+ *redirect_uri* - RFC 9126 section 2.1
+ *code_challenge* - RFC 9126 section 2.1
+ *code_challenge_method* - RFC 9126 section 2.1
+ *scope* - “org.iso.18013.5.1.mDL openid” or “eu.europa.ec.eudiw.pid.1 openid”

At the end of this request, you receive a JSON that contains:

+ *expires_in* - RFC 9126 see section 2.2
+ *request_uri* - RFC 9126 see section 2.2

## 3. Authorization Request

It is necessary to save the *"request_uri"* from the previous request (see section 2) to be used in the GET request for Authorization.

In addition to the *"request_uri"* the following data is required:

+ *client_id* - Required. The client identifier as described in RFC6749 2.2
+ *request_uri* - RFC 9126 see section 2.2

In the end, a redirect is made to a website where the user needs to select one of the countries for which authentication is required to obtain user data from the PID. 
At the end of this authentication, the follow parameters are obtained:

+ *state* - Required. Same value received from client
+ *scope*
+ *code* - Required. Authorization code generated by authorization server 
+ *iss*
+ *client_id*

## 4. Token request

The "code" and "state" (see section 3) need to be saved to make the POST request for the Token.

The attributes required to make the request are:

+ *grant_type* - Required. Value must be set to “authorization_code”
+ *code* - Required. The authorization code received from server
+ *redirect_uri* - Required. Must be identical value to authorization requrest redirect_uri
+ *client_id* - Required.
+ *state* - Recommended. 
+ *code_verifier* - RFC 7636 see section 4.1

At the end of this request, you get a JSON with:

+ *token_type*
+ *scope*
+ *access_token*
+ *expires_in*
+ *id_token*

## 5. Credential Request

Finally, the last required request is the POST request for Credentials.

To make this request, you need to save the *"access_token"* from the previous request (see section 4), and additionally, the following attributes are required:

+ *format* - Required. Format of credential to be issued. (vc+sd-jwt / mso_mdoc)
+ *doctype* - For mso_mdoc format
+ *proof* - Optional  JWT

In the end, you receive a JSON with:

+ *c_nonce* - Required. JSON string containing a nonce
+ *c_nonce_expires_in* - Required. Json integer denoting lifetime of c_nonce
+ *error*
+ *error_description*
+ *credential* - Optional. Contains issued Credential
+ *format* - Required. Json string denoting format
